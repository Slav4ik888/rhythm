#!/bin/bash

set -e # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§–ª–∞–≥–∏
FRONT_ONLY=false

log() {
  echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
  echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1"
  exit 1
}

warning() {
  echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
run_command() {
  log "–í—ã–ø–æ–ª–Ω—è—é: $1"
  if eval "$1"; then
    log "‚úÖ –£—Å–ø–µ—à–Ω–æ: $1"
  else
    error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏: $1"
  fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–º–æ—â–∏
show_help() {
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [OPTIONS]"
  echo ""
  echo "OPTIONS:"
  echo "  -frontOnly    –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä–∫—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —á–∞—Å—Ç–∏"
  echo "  -h, --help    –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏"
  echo ""
  echo "–ü—Ä–∏–º–µ—Ä—ã:"
  echo "  $0              # –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π (–±—ç–∫–µ–Ω–¥ + —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)"
  echo "  $0 -frontOnly   # –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
parse_arguments() {
  while [[ $# -gt 0 ]]; do
    case $1 in
      -frontOnly)
        FRONT_ONLY=true
        shift
        ;;
      -h|--help)
        show_help
        exit 0
        ;;
      *)
        error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1"
        ;;
    esac
  done
}

# –§—É–Ω–∫—Ü–∏—è –¥–µ–ø–ª–æ—è –±—ç–∫–µ–Ω–¥–∞
deploy_backend() {
  log "üîß –î–µ–ø–ª–æ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏..."
  run_command "cd /var/www/vtempe/data/rhythm-server"
  run_command "git pull"
  run_command "npm run build"
}

# –§—É–Ω–∫—Ü–∏—è –¥–µ–ø–ª–æ—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
deploy_frontend() {
  log "üé® –î–µ–ø–ª–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏..."
  run_command "cd /var/www/vtempe/data/rhythm"
  run_command "git pull"
  run_command "npm run build:prod"
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
restart_service() {
  log "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
  run_command "service rhythm-server restart"
}

# –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π
full_deploy() {
  log "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–ø–ª–æ—è..."
  deploy_backend
  deploy_frontend
  restart_service
}

# –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
frontend_only_deploy() {
  log "üé® –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è —Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —á–∞—Å—Ç–∏..."
  deploy_frontend
  log "‚ÑπÔ∏è  –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±—Ä–∞–Ω, –Ω–æ —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±—ç–∫–µ–Ω–¥–∞)"
}

# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
main() {
  parse_arguments "$@"
  
  if [ "$FRONT_ONLY" = true ]; then
    frontend_only_deploy
  else
    full_deploy
  fi
  
  log "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
main "$@"




# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
run_command() {
  log "–í—ã–ø–æ–ª–Ω—è—é: $1"
  if eval "$1"; then
    log "‚úÖ –£—Å–ø–µ—à–Ω–æ: $1"
  else
    error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏: $1"
  fi
}

# –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
# chmod +x deploy.sh
# ./deploy.sh
